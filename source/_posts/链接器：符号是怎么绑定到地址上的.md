---
title: 链接器：符号是怎么绑定到地址上的
toc: true
date: 2019-07-16 06:44:55
tags:
- 学习笔记-iOS
categories:
- iOS
---



> 链接器最主要的作用，就是将符号绑定到地址上

## iOS 开发为什么使用的是编译器？

iOS 编写的代码是先使用编译器把代码编译成机器码，然后直接在 CPU 上执行机器码的。之所以不使用解释器来运行代码，是因为苹果公司希望 iPhone 的执行效率更高、运行速度能达到最快。

> 为什么说用解释器运行代码的速度不够快呢？
>
> 因为解释器会在运行时解释执行代码，获取一段代码后就会将其翻译成目标代码（就是字节码（Bytecode）），然后一句一句地执行目标代码。
>
> 也就是说，解释器，是在运行时才去解析代码，这样就比在运行之前通过编译器生成一份完整的机器码再去执行的效率要低。

|        | 优点                                       | 缺点             |
| ------ | ------------------------------------------ | ---------------- |
| 编译器 | 1.效率高<br>2.运行速度快                   | 1.调试周期长<br> |
| 解释器 | 1.调试方便<br>2.缩短开发周期和功能更新周期 | 1.执行效率低     |

##  iOS 开发使用的到底是什么编译器

现在苹果公司使用的编译器是 LLVM，相比于 Xcode 5 版本前使用的 GCC，编译速度提高了 3 倍。同时，苹果公司也反过来主导了 LLVM 的发展，让 LLVM 可以针对苹果公司的硬件进行更多的优化。

LLVM 是编译器工具链技术的一个集合。而其中的 lld 项目，就是内置链接器。编译器会对每个文件进行编译，生成 Mach-O（可执行文件）；链接器会将项目中的多个 Mach-O 文件合并成一个。

**编译的几个主要过程：**

* 首先，你写好代码后，LLVM 会预处理你的代码，比如把宏嵌入到对应的位置。

* 预处理完后，LLVM 会对代码进行词法分析和语法分析，生成 AST 。

  > AST 是抽象语法树，结构上比代码更精简，遍历起来更快，所以使用 AST 能够更快速地进行静态检查，同时还能更快地生成 IR（中间表示）。

* 最后 AST 会生成 IR，IR 是一种更接近机器码的语言，区别在于和平台无关，通过 IR 可以生成多份适合不同平台的机器码。对于 iOS 系统，IR 生成的可执行文件就是 Mach-O。

## 编译时链接器做了什么

Mach-O 文件里面的内容，主要就是代码和数据：代码是函数的定义；数据是全局变量的定义，包括全局变量的初始值。不管是代码还是数据，它们的实例都需要由符号将其关联起来。

为什么呢？因为 Mach-O 文件里的那些代码，比如 if、for、while 生成的机器指令序列，要操作的数据会存储在某个地方，变量符号就需要绑定到数据的存储地址。你写的代码还会引用其他的代码，引用的函数符号也需要绑定到该函数的地址上。

而链接器的作用，就是完成变量、函数符号和其地址绑定这样的任务。而这里我们所说的符号，就可以理解为变量名和函数名。

## 项目中Mach-O文件的合并

**链接器为什么还要把项目中的多个 Mach-O 文件合并成一个？**

你肯定不希望一个项目是在一个文件里从头写到尾的吧。项目中文件之间的变量和接口函数都是相互依赖的，所以这时我们就需要通过链接器将项目中生成的多个 Mach-O 文件的符号和地址绑定起来。

没有这个绑定过程的话，单个文件生成的 Mach-O 文件是无法正常运行起来的。因为，如果运行时碰到调用在其他文件中实现的函数的情况时，就会找不到这个调用函数的地址，从而无法继续执行。

链接器在链接多个目标文件的过程中，会创建一个符号表，用于记录所有已定义的和所有未定义的符号。链接时如果出现相同符号的情况，就会出现“ld: dumplicate symbols”的错误信息；如果在其他目标文件里没有找到符号，就会提示“Undefined symbols”的错误信息。

## 链接器对代码主要做了哪几件事儿

* 去项目文件里查找目标代码文件里没有定义的变量。
* 扫描项目中的不同文件，将所有符号定义和引用地址收集起来，并放到全局符号表中。
* 计算合并后长度及位置，生成同类型的段进行合并，建立绑定。
* 对项目中不同文件里的变量进行地址重定位。